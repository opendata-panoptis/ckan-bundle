{% extends "package/read_base.html" %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
{% endblock %}

{% block primary_content_inner %}

<section class="mb-5 relationships">
    <h2>{{ _('Existing Relationships') }}</h2>

    {% set existing_relationships = h.get_relationships(pkg_dict['id']) %}

    {% if existing_relationships %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle existing_relationships">
                <thead>
                    <tr>
                        <th width="20%">{{ _('Type') }}</th>
                        <th>{{ _('CKAN Dataset') }}</th>
                        {% if h.check_access('package_update', {'id':pkg.id }) %}
                            <th width="15%">{{ _('Action') }}</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for relationship in existing_relationships %}
                    <tr>
                        <td>{{ _(relationship.type) }}</td>
                        <td>
                            {% if relationship.object %}
                                <a href="{{ h.url_for('dataset.read', id=relationship.object) }}" class="text-primary fw-semibold">
                                    {{ relationship.title }}
                                </a>
                            {% else %}
                                <a href="{{ relationship.comment }}" target="_blank" class="text-primary">
                                    {{ relationship.comment }}
                                </a>
                            {% endif %}
                        </td>
                        {% if h.check_access('package_update', {'id':pkg.id }) %}
                        <td>
                            {% if relationship.object %}
                                <a href="{{ h.url_for('relationships.delete', id=pkg_dict['name'], type=relationship.type, rel_by='object', reference=relationship.object) }}"
                                   class="btn btn-outline-danger btn-sm">
                                    {{ _('Delete') }}
                                </a>
                            {% else %}
                                {% set uri = h.quote_uri(relationship.comment) %}
                                <a href="{{ h.url_for('relationships.delete', id=pkg_dict['name'], type=relationship.type, rel_by='uri', reference=uri) }}"
                                   class="btn btn-outline-danger btn-sm">
                                    {{ _('Delete') }}
                                </a>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="text-muted">{{ _('There are no existing relationships.') }}</p>
    {% endif %}
</section>

<section class="mb-5 relationships">
    {% if h.check_access('package_update', {'id':pkg.id }) %}

    <h2>{{ _('Create relationship') }}</h2>

    <div class="mb-4">
        <div class="card shadow-sm border-0 mb-4 p-4" style="background-color: #f9f9f9;">
            <h4 class="fw-bold mb-3">
                <i class="bi bi-diagram-3-fill me-2 text-primary"></i>
                {{ _('CKAN dataset to dataset relationship') }}
            </h4>

            {% set relatable_datasets = h.get_relatable_datasets(pkg_dict['id']) %}

            {% if relatable_datasets %}
                <form action="/dataset/{{ pkg_dict['name'] }}/relationships/create" method="post" class="row g-3">
                    {{ h.csrf_input() }}

                    <div class="col-md-6">
                        <label class="form-label">{{ _('Relationship type') }}</label>
                        <select name="type" class="form-select">
                            {% for option in h.get_relationship_types() %}
                                    <option value="{{ option }}">{{ _(option) }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6">
                        <div class="dataset-select-container">
                            <div class="dataset-select-wrapper">
                                <label class="form-label" for="target-dataset-select">{{ _('Target dataset') }}</label>
                                <select name="object"
                                        id="target-dataset-select"
                                        class="selectpicker"
                                        data-live-search="true"
                                        data-style="btn-outline-secondary">
                                    {% for dataset in relatable_datasets %}
                                        <option value="{{ dataset.name }}">{{ dataset.title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="button"
                                    class="btn btn-outline-primary dataset-view-btn"
                                    id="view-dataset-btn"
                                    onclick="viewSelectedDataset()"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="{{ _('View Dataset') }}">
                                <i class="fa fa-external-link"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-12">
                        <input class="btn btn-primary" type="submit" value="{{ _('Add CKAN relationship') }}">
                    </div>
                </form>
            {% else %}
                <p class="text-muted">{{ _('There are no other datasets to link to.') }}</p>
            {% endif %}
        </div>

        <hr class="my-5">

        <div class="card shadow-sm border-0 p-4" style="background-color: #f0f4ff;">
            <h4 class="fw-bold mb-3">
                <i class="bi bi-link-45deg me-2 text-info"></i>
                {{ _('CKAN dataset to external URI relationship') }}
            </h4>

            <form action="/dataset/{{ pkg_dict['name'] }}/relationships/create" method="post" class="row g-3">
                {{ h.csrf_input() }}

                <div class="col-md-6">
                    <label class="form-label">{{ _('Relationship type') }}</label>
                    <select name="type" class="form-select">
                        {% for option in h.get_relationship_types() %}
                            <option value="{{ option }}">{{ _(option) }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">{{ _('External URI') }}</label>
                    <input type="text" name="uri" class="form-control" placeholder="https://example.com/resource">
                </div>

                <div class="col-12">
                    <input class="btn btn-primary" type="submit" value="{{ _('Add URI relationship') }}">
                </div>
            </form>
        </div>
    </div>

    {% endif %}
</section>

<script>
function viewSelectedDataset() {
    const selectElement = document.getElementById('target-dataset-select');
    const selectedOption = selectElement.options[selectElement.selectedIndex];

    if (selectedOption && selectedOption.value) {
        const datasetName = selectedOption.value;
        const url = '{{ h.url_for("dataset.read", id="DATASET_NAME") }}'.replace('DATASET_NAME', datasetName);
        window.open(url, '_blank');
    } else {
        alert('{{ _("Please select a dataset first") }}');
    }
}

// Ενεργοποίηση/απενεργοποίηση του κουμπιού ανάλογα με την επιλογή
document.addEventListener('DOMContentLoaded', function() {
    const selectElement = document.getElementById('target-dataset-select');
    const viewButton = document.getElementById('view-dataset-btn');

    function toggleButton() {
        viewButton.disabled = !selectElement.value;
    }

    selectElement.addEventListener('change', toggleButton);
    toggleButton(); // Αρχική κατάσταση
});
</script>

{% endblock %}