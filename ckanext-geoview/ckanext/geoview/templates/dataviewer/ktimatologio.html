{% extends "dataviewer/base.html" %}

{% block page %}
    {% set lang = h.lang() %}
    <style>
        #ktimatologio-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        #ktimatologio-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .ktimatologio-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid #28a745;
            border-radius: 4px;
        }
        .loading-dialog {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .guide-button {
            display: inline-block;
            padding: 4px 8px;
            margin: 0 5px;
            border: 1px solid #b0c4de; /* Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ Î¼Ï€Î»Îµ Ï€ÎµÏÎ¯Î³ÏÎ±Î¼Î¼Î± */
            background-color: #e6f0fa; /* Î Î¿Î»Ï Î±Î½Î¿Î¹Ï‡Ï„ÏŒ Î¼Ï€Î»Îµ Ï†ÏŒÎ½Ï„Î¿ */
            border-radius: 4px;
            color: #4682B4; /* Î§ÏÏÎ¼Î± ÎµÎ¹ÎºÎ¿Î½Î¹Î´Î¯Î¿Ï… (Î±Ï„ÏƒÎ¬Î»Î¹Î½Î¿ Î¼Ï€Î»Îµ) */
            font-size: 16px;
            vertical-align: middle; /* Î£Ï‰ÏƒÏ„Î® ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ· Î¼Îµ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ */
            line-height: 1;
        }
    </style>

    <div class="ktimatologio-info">
        {% if lang == 'el' %}
            <h4>Î•Î½ÏƒÏ‰Î¼Î¬Ï„Ï‰ÏƒÎ· Î•Î»Î»Î·Î½Î¹ÎºÎ¿Ï ÎšÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï…</h4>
            <p>Î‘Ï…Ï„Î® Î· Ï€ÏÎ¿Î²Î¿Î»Î® ÎµÎ½ÏƒÏ‰Î¼Î±Ï„ÏÎ½ÎµÎ¹ Ï„Î·Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î± Ï„Î¿Ï… Î•Î»Î»Î·Î½Î¹ÎºÎ¿Ï ÎšÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï… (https://maps.ktimatologio.gr) Î³Î¹Î± Î²ÎµÎ»Ï„Î¹Ï‰Î¼Î­Î½Î· ÎºÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¹ÎºÎ® ÎºÎ±Î¹ Î³ÎµÏ‰Î³ÏÎ±Ï†Î¹ÎºÎ® Î¿Ï€Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·.</p>
        {% else %}
            <h4>Greek Ktimatologio Integration</h4>
            <p>This view integrates the Greek Ktimatologio service for enhanced cadastral and geographic visualization.</p>
        {% endif %}
        
        {# Manual loading mode - user needs to download and upload #}
        <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 10px; margin: 10px 0;">
            {% if lang == 'el' %}
                <h5 style="color: #0c5460; margin-top: 0;">ğŸ—ºï¸ ÎŸÎ´Î·Î³Î¯ÎµÏ‚ Î§ÏÎ®ÏƒÎ·Ï‚:</h5>
                <ol style="margin: 5px 0; padding-left: 20px; color: #0c5460;">
                    <li><strong>ÎšÎ±Ï„ÎµÎ²Î¬ÏƒÏ„Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿:</strong> ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº ÏƒÏ„Î¿Î½ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿ Î³Î¹Î± Î½Î± ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ Ï„Î¿ Î³ÎµÏ‰Î³ÏÎ±Ï†Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿</li>
                    <li><strong>Î‘Î½Î¿Î¯Î¾Ï„Îµ Ï„Î¿ ÎšÏ„Î·Î¼Î±Ï„Î¿Î»ÏŒÎ³Î¹Î¿:</strong> ÎŸ Ï‡Î¬ÏÏ„Î·Ï‚ Ï„Î¿Ï… ÎšÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï… Î¸Î± Ï†Î¿ÏÏ„Ï‰Î¸ÎµÎ¯ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰</li>
                    <li><strong>Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·:</strong> Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î± ÎµÏÎ³Î±Î»ÎµÎ¯Î± Ï„Î¿Ï… ÎšÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï… Î³Î¹Î± Î½Î± ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï€Î¿Ï… ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎ±Ï„Îµ</li>
                    <li><strong>Î•Î¾ÎµÏÎµÏ…Î½Î®ÏƒÏ„Îµ Ï„Î± ÎºÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î±:</strong> Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î¹Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚ Ï„Î¿Ï… Ï‡Î¬ÏÏ„Î·</li>
                </ol>
            {% else %}
                <h5 style="color: #0c5460; margin-top: 0;">ğŸ—ºï¸ Usage Instructions:</h5>
                <ol style="margin: 5px 0; padding-left: 20px; color: #0c5460;">
                    <li><strong>Download the file:</strong> Click the link below to download the geographic file</li>
                    <li><strong>Open Ktimatologio:</strong> The Ktimatologio map will load below</li>
                    <li><strong>Add the file to the map:</strong> Use Ktimatologio's tools to import the file you downloaded</li>
                    <li><strong>Explore the cadastral data:</strong> Use the map's features </li>
                </ol>
            {% endif %}
        </div>

        {% if resource_url %}
            {# Always show download link in manual mode #}
            {% if lang == 'el' %}
                <p><strong>Î›Î®ÏˆÎ· Î‘ÏÏ‡ÎµÎ¯Î¿Ï…:</strong>
                    <a href="{{ resource_url }}" target="_blank" style="background-color: #28a745; color: white; padding: 5px 10px; text-decoration: none; border-radius: 3px;">
                        â¬‡ï¸ {{ resource.name or resource_url }}
                    </a>
                    {% if resource_format %}
                        <span style="background-color: #6c757d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">{{ resource_format.upper() }}</span>
                    {% endif %}
                </p>
            {% else %}
                <p><strong>Original Resource:</strong> 
                    <a href="{{ resource_url }}" target="_blank" style="background-color: #28a745; color: white; padding: 5px 10px; text-decoration: none; border-radius: 3px;">
                        ğŸ“¥ Download: {{ resource.name or resource_url }}
                    </a>
                    {% if resource_format %}
                        <span style="background-color: #6c757d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">{{ resource_format.upper() }}</span>
                    {% endif %}
                </p>
            {% endif %}
        {% endif %}
    </div>

    <div id="ktimatologio-container">
        <div class="loading-dialog" id="loading-dialog">
            <div class="loading-spinner"></div>
            {% if lang == 'el' %}
                <span>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÎšÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï…...</span>
            {% else %}
                <span>Loading Ktimatologio...</span>
            {% endif %}
        </div>
        <iframe id="ktimatologio-iframe" 
                src="{{ ktimatologio_url }}" 
                title="{% if lang == 'el' %}Î•Î»Î»Î·Î½Î¹ÎºÎ® Î¥Ï€Î·ÏÎµÏƒÎ¯Î± ÎšÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï…{% else %}Greek Ktimatologio Service{% endif %}"
                style="display: none;"
                onload="document.getElementById('loading-dialog').style.display='none'; this.style.display='block';">
        </iframe>
    </div>

    <div class="ktimatologio-info" style="margin-top: 15px;">
        <small>
            {% if lang == 'el' %}
                Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î±Ï€ÏŒ 
                <a href="https://maps.ktimatologio.gr" target="_blank">Î•Î»Î»Î·Î½Î¹ÎºÎ® Î¥Ï€Î·ÏÎµÏƒÎ¯Î± ÎšÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï…</a> - 
                Î•Î»Î»Î·Î½Î¹ÎºÏŒÏ‚ ÎŸÏÎ³Î±Î½Î¹ÏƒÎ¼ÏŒÏ‚ ÎšÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï… ÎºÎ±Î¹ Î§Î±ÏÏ„Î¿Î³ÏÎ±Ï†Î®ÏƒÎµÏ‰Î½
            {% else %}
                Powered by 
                <a href="https://maps.ktimatologio.gr" target="_blank">Greek Ktimatologio Service</a> - 
                Hellenic Cadastre and Mapping Organization
            {% endif %}
        </small>
    </div>

    <script>
        // Handle iframe loading and error cases
        document.addEventListener('DOMContentLoaded', function() {
            var iframe = document.getElementById('ktimatologio-iframe');
            var loadingDialog = document.getElementById('loading-dialog');
            
            // Set a timeout in case the iframe doesn't load
            setTimeout(function() {
                if (loadingDialog.style.display !== 'none') {
                    {% if lang == 'el' %}
                        loadingDialog.innerHTML = '<span style="color: #dc3545;">Î‘Î´ÏÎ½Î±Ï„Î· Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¿Ï… ÎšÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï…. Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ® ÏƒÎ±Ï‚ ÏƒÏ„Î¿ Î´Î¹Î±Î´Î¯ÎºÏ„Ï…Î¿ Î® Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬ Î±ÏÎ³ÏŒÏ„ÎµÏÎ±.</span>';
                    {% else %}
                        loadingDialog.innerHTML = '<span style="color: #dc3545;">Unable to load Ktimatologio. Please check your internet connection or try again later.</span>';
                    {% endif %}
                }
            }, 15000); // 15 second timeout
            
            // Handle iframe errors
            iframe.addEventListener('error', function() {
                {% if lang == 'el' %}
                    loadingDialog.innerHTML = '<span style="color: #dc3545;">Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï„Î·Ï‚ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ ÎšÏ„Î·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î¿Ï….</span>';
                {% else %}
                    loadingDialog.innerHTML = '<span style="color: #dc3545;">Error loading Ktimatologio service.</span>';
                {% endif %}
            });
        });
    </script>

{% endblock %}