# Υλοποίηση Ειδοποιήσεων για Μη Επικαιροποιημένα Σύνολα Δεδομένων

## Επισκόπηση

Έχουμε υλοποιήσει μια λειτουργία ειδοποιήσεων για τα μη επικαιροποιημένα σύνολα δεδομένων στο CKAN. Η υλοποίηση περιλαμβάνει μια νέα εντολή CLI που δημιουργεί αναφορές για μη επικαιροποιημένα σύνολα δεδομένων και στέλνει ειδοποιήσεις στους διαχειριστές των οργανισμών μέσω email.

Αυτή η λειτουργία έχει ως σκοπό να διατηρεί τους διαχειριστές των οργανισμών ενήμερους για την κατάσταση των συνόλων δεδομένων τους, βοηθώντας τους να ενημερώσουν τα στοιχεία τους σύμφωνα με την αναμενόμενη συχνότητα. Η αναφορά αποστέλλεται περιστασιακά (εβδομαδιαίως) και περιλαμβάνει πληροφορίες για τα σύνολα δεδομένων που χρειάζονται ενημέρωση.

Η ειδοποίηση αποτελεί μέρος της διαδικασίας διασφάλισης ποιότητας των δεδομένων και βοηθά στη διατήρηση ενός υψηλού επιπέδου ενημέρωσης των περιεχομένων της πλατφόρμας. Πρόκειται για ένα αυτοματοποιημένο μήνυμα που στέλνεται από το σύστημα για να σας ενημερώσει περιοδικά για την κατάσταση των συνόλων δεδομένων σας.

## Αρχεία που δημιουργήθηκαν/τροποποιήθηκαν

### 1. CLI Command - `/ckanext/report/cli.py`

Προστέθηκε η εντολή `send_stale_report` με τις ακόλουθες δυνατότητες:

- Δημιουργία αναφοράς για μη επικαιροποιημένα σύνολα δεδομένων
- Φιλτράρισμα ανά οργανισμό (προαιρετικά)
- Αποστολή email σε διαχειριστές οργανισμών
- Δυνατότητα δοκιμαστικής αποστολής email

### 2. Email Templates

Δημιουργήθηκαν δύο πρότυπα για τη μορφοποίηση των email:

#### a) Text Template - `/ckanext/report/templates/report/stale_datasets_report_email.txt`

Περιέχει την αναφορά σε μορφή απλού κειμένου.

#### b) HTML Template - `/ckanext/report/templates/report/stale_datasets_report_email.html`

Περιέχει την αναφορά σε μορφή HTML για καλύτερη απεικόνιση.

## Χρήση των Template

Τα template χρησιμοποιούν τη βιβλιοθήκη Jinja2 για τη δημιουργία των email. Αυτό επιτρέπει τη διαχωρισμένη ανάπτυξη της λογικής (στο CLI) από την παρουσίαση (στα template).

### Δομή των Template

Και τα δύο template λαμβάνουν τα ίδια δεδομένα και περιλαμβάνουν:

- Περίληψη της αναφοράς (συνολικός αριθμός συνόλων, μη επικαιροποιημένα, επικαιροποιημένα)
- Λίστα με τα μη επικαιροποιημένα σύνολα δεδομένων
- Ζητούν από τους διαχειριστές να ενημερώσουν τα σύνολα δεδομένων τους
- Σύνδεσμο προς την online αναφορά

### Πλεονεκτήματα της Προσέγγισης

   - Ο κώδικας παραμένει στο CLI αρχείο
   - Η παρουσίαση (HTML και text) παραμένει στα template αρχεία
   - Αυτό καθιστά τον κώδικα πιο ευκολοσυντήρητο και ευέλικτο

2. **Ευκολία συντήρησης**:
   - Οι αλλαγές στην εμφάνιση των email μπορούν να γίνουν απευθείας στα template αρχεία
   - Δεν χρειάζεται να αλλάξουμε τον Python κώδικα για να αλλάξουμε τη μορφοποίηση

3. **Επαναχρησιμοποίηση κώδικα**:
   - Χρησιμοποιούμε την ίδια μέθοδο render που χρησιμοποιείται και αλλού στο CKAN
   - Η λογική δημιουργίας των email είναι πιο καθαρή

## Επιλογή Παραληπτών Email

Προστέθηκε η δυνατότητα να επιλέγετε σε ποιους θα αποστέλλονται τα email μέσω του αρχείου ρυθμίσεων ckan.ini. Υποστηρίζονται οι ακόλουθες επιλογές:

- `admins` - αποστολή στους διαχειριστές του οργανισμού (προεπιλογή)
- `org` - αποστολή στη διεύθυνση email του οργανισμού
- `both` - αποστολή και στους διαχειριστές και στη διεύθυνση email του οργανισμού

Για να χρησιμοποιήσετε αυτήν τη δυνατότητα, προσθέστε την ακόλουθη ρύθμιση στο αρχείο ckan.ini:

```ini
## Report settings #############################################################
# Επιλογή τύπου αποστολής email:
# "admins" - αποστολή στους διαχειριστές του οργανισμού (προεπιλογή)
# "org" - αποστολή στη διεύθυνση email του οργανισμού
# "both" - αποστολή και στους διαχειριστές και στη διεύθυνση email του οργανισμού
ckanext.report.email_recipients = admins
```

## Χρήση

### Βασική εντολή

```bash
ckan --config=/path/to/ckan.ini report send-stale-report
```

Αυτή η εντολή δημιουργεί και εμφανίζει μια αναφορά για όλους τους οργανισμούς χωρίς να στείλει email.

### Επιλογές

1. **Φιλτράρισμα ανά οργανισμό:**
   ```bash
   ckan --config=/path/to/ckan.ini report send-stale-report -o organization_name
   ```

2. **Αποστολή email με βάση το τι παραλήπτες έχουμε δηλώσει:**
   ```bash
   ckan --config=/path/to/ckan.ini report send-stale-report -s
   ```

3. **Δοκιμαστική αποστολή email:**
   ```bash
   ckan --config=/path/to/ckan.ini report send-stale-report -t test@example.com
   ```

## Ρύθμιση SMTP

Για να λειτουργήσει η αποστολή email, πρέπει να ρυθμιστεί ο SMTP server στο αρχείο ρυθμίσεων του CKAN (`ckan.ini`):

```ini
## Email settings ##############################################################
smtp.server = smtp.gmail.com:587
smtp.starttls = True
smtp.user = your_username@gmail.com
smtp.password = your_gmail_password
smtp.mail_from = your_username@gmail.com
smtp.reply_to = noreply@example.com
email_to = 
```

## Αυτοματοποίηση με Cron Job

Για την αυτόματη αποστολή ειδοποιήσεων, δημιουργήσαμε ένα cron job:

```bash
@weekly ckan -c /path/to/ckan.ini report send-stale-report -s > /dev/null
```

Αυτό το cron job εκτελείται εβδομαδιαίως και στέλνει όλες τις εκκρεμείς ειδοποιήσεις.

Για να ρυθμίσετε το cron job:

1. Εκτελέστε την εντολή:
   ```bash
   crontab -e
   ```

2. Προσθέστε τη γραμμή:
   ```bash
   @weekly ckan -c /path/to/ckan.ini report send-stale-report -s > /dev/null
   ```

3. Αποθηκεύστε και κλείστε τον editor.

Η εντολή `@weekly` εκτελεί το job κάθε Κυριακή στις 00:00. Μπορείτε να αλλάξετε τη συχνότητα αντικαθιστώντας το `@weekly` με:
- `@daily` για καθημερινή εκτέλεση
- `@monthly` για μηνιαία εκτέλεση
- `0 9 * * 1` για εκτέλεση κάθε Δευτέρα στις 9:00 π.μ.

Βεβαιωθείτε ότι η διαδρομή για το `ckan` είναι σωστή. Μπορείτε να τη βρείτε εκτελώντας:
```bash
which ckan
```

## Λειτουργία

Όταν εκτελείται η εντολή με την επιλογή `-s`, το σύστημα:

1. Δημιουργεί αναφορά με τα μη επικαιροποιημένα σύνολα δεδομένων
2. Ομαδοποιεί τα σύνολα δεδομένων ανά οργανισμό
3. Εντοπίζει τους διαχειριστές ή/και στη διεύθυνση email του κάθε οργανισμού
4. Στέλνει εξατομικευμένη αναφορά σε κάθε διαχειριστή οργανισμού
5. Αποστέλλει μόνο σε οργανισμούς που έχουν μη επικαιροποιημένα σύνολα δεδομένων

## Report Plugin

Η λειτουργία ενσωματώνεται στο υπάρχον report plugin του CKAN. Η εντολή `send-stale-report` είναι μέρος της ομάδας εντολών `report` και χρησιμοποιεί την υπάρχουσα δομή του report plugin για τη δημιουργία και διαχείριση των αναφορών.

Για να είναι διαθέσιμη η λειτουργία, το plugin `report` πρέπει να είναι ενεργοποιημένο στο αρχείο ρυθμίσεων του CKAN:

```ini
ckan.plugins = report ...
```

Η αναφορά είναι προσβάσιμη και μέσω της web διεπαφής στη διεύθυνση:
```
/report/stale-datasets/