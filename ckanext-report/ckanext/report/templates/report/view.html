{% extends "page.html" %}

{% block body_class %}report-page{% endblock %}

{% block title %}
  {% if 'metadata' in report_name %}
    {{ gettext('Metadata Quality', domain='ckanext-qa') }} - {{ _('Reports') }} - {{ super() }}
  {% elif 'openness' in report_name %}
    {{ gettext('Openness (Five Stars)', domain='ckanext-qa') }} - {{ _('Reports') }} - {{ super() }}
  {% elif 'broken' in report_name %}
    {{ gettext('Broken links', domain='ckanext-archiver') }} - {{ _('Reports') }} - {{ super() }}
  {% elif 'tagless' in report_name %}
    {{ gettext('Tagless Datasets', domain='ckanext-report') }} - {{ _('Reports') }} - {{ super() }}
  {% elif 'stale-datasets' in report_name %}
    {{ gettext('Stale Datasets', domain='ckanext-report') }} - {{ _('Reports') }} - {{ super() }}
  {% else %}
    {{ report.title }} - {{ _('Reports') }} - {{ super() }}
  {% endif %}
{% endblock %}

{% block breadcrumb_content %}
  <li>{{ h.nav_link(_('Reports'), named_route='report.index') }}</li>
  <li>
    {% if 'metadata' in report_name %}
      {{ h.nav_link(gettext('Metadata Quality', domain='ckanext-qa'), named_route='report.view', report_name=report_name) }}
    {% elif 'openness' in report_name %}
      {{ h.nav_link(gettext('Openness (Five Stars)', domain='ckanext-qa'), named_route='report.view', report_name=report_name) }}
    {% elif 'broken' in report_name %}
      {{ h.nav_link(gettext('Broken links', domain='ckanext-archiver'), named_route='report.view', report_name=report_name) }}
    {% elif 'tagless' in report_name %}
      {{ h.nav_link(gettext('Tagless Datasets', domain='ckanext-report'), named_route='report.view', report_name=report_name) }}
    {% elif 'stale-datasets' in report_name %}
      {{ h.nav_link(gettext('Stale Datasets', domain='ckanext-report'), named_route='report.view', report_name=report_name) }}
    {% else %}
      {{ h.nav_link(report.title, named_route='report.view', report_name=report_name) }}
    {% endif %}
  </li>
  {% if organization %}
    <li>{{ h.nav_link(organization, named_route='report.org', report_name=report_name, organization=organization) }}</li>
  {% endif %}
{% endblock%}

{% block primary_content_inner %}
  {% set type = 'asset' if h.check_ckan_version(min_version="2.9.0", max_version="3.0.0") else 'resource' %}
  {% include 'report/report_js_' ~ type ~ '.html' %}
  <div class="dataset report-view-section">
      <h1 class="report-title">
        {% if 'metadata' in report_name %}
          {{ gettext('Metadata Quality', domain='ckanext-qa') }}
        {% elif 'openness' in report_name %}
          {{ gettext('Openness (Five Stars)', domain='ckanext-qa') }}
        {% elif 'broken' in report_name %}
          {{ gettext('Broken links', domain='ckanext-archiver') }}
        {% elif 'tagless' in report_name %}
          {{ gettext('Tagless Datasets', domain='ckanext-report') }}
        {% elif 'stale-datasets' in report_name %}
          {{ gettext('Stale Datasets', domain='ckanext-report') }}
        {% else %}
          {{ report.title }}
        {% endif %}
      </h1>
      <p>
        {% if 'metadata' in report_name %}
          {{ gettext('Datasets graded on metadata quality, based on the MQA method', domain='ckanext-qa') }}
        {% elif 'openness' in report_name %}
          {{ gettext('Datasets graded on Tim Berners Lees\' Five Stars of Openness - openly licensed, openly accessible, structured, open format, URIs for entities, linked.', domain='ckanext-qa') }}
        {% elif 'broken' in report_name %}
          {{ gettext('Dataset resource URLs that are found to result in errors when resolved.', domain='ckanext-archiver') }}
        {% elif 'tagless' in report_name %}
          {{ gettext('Datasets which have no tags.', domain='ckanext-report') }}
        {% else %}
          {{ report.description }}
        {% endif %}
      </p>
      <p>
          {{ _('Generated') }}: {{ h.report__render_datetime(report_date, '%d/%m/%Y %H:%M') }}
      </p>
      {% if c.userobj.sysadmin %}
      <div class="panel panel-info refresh-panel">
          <div class="panel-heading"><strong>{% trans %}Refresh report{% endtrans %}</strong></div>
          <div class="panel-body">
            <form action="" method="POST">
              <input type="submit" value="{% trans %}Refresh{% endtrans %}" class="btn btn-info pull-right" style="margin-left: 15px"/>
            </form>
            <p>{{ _('As a system administrator you are able to refresh this report on demand by clicking the \'Refresh\' button.') }}</p>
          </div>
      </div>
      {% endif %}

      {% if options %}
        <h3>{{ _('Options') }}</h3>
        <form action="">
          {% for key, value in options.items() %}
            {% if key in options_html %}
              {{ options_html[key]|safe }}
            {% else %}
              {{ key }}: {{ value }}
              <input type="hidden" name="{{ key }}" value="{{ value }}"/>
            {% endif %}
            <br/>
          {% endfor %}
        </form>
      {% endif %}

      {% if are_some_results %}
        <div class="pull-right">
            {{ _('Download') }}:
            <a class="btn btn-primary" href="{{ h.report__relative_url_for(format='csv') }}">CSV</a>
            <a class="btn btn-primary" href="{{ h.report__relative_url_for(format='json') }}">JSON</a>
        </div>
      {% endif %}
      <h3>{{ _('Results') }}</h3>
      {% if not are_some_results %}
        <p>{{ _('No results found.') }}</p>
      {% else %}
        <div class="pull-left">
          {% snippet report_template, table=data['table'], data=data, report_name=report_name, options=options, lib=lib %}
        </div>
      {% endif %}
  </div>
  
  <style>
    /* Override CKAN core styles for .dataset class */
    .report-view-section.dataset {
      float: none !important;
      width: 100% !important;
      max-width: 1280px;
      margin: 0 auto !important;      /* κεντράρισμα */
      border-left: none !important;   /* φεύγει η γκρίζα κάθετη γραμμή */
      border-top: none !important;    /* φεύγει η οριζόντια γραμμή */
      padding-left: 24px !important;  /* εσωτερικό κενό αριστερά */
      padding-right: 24px !important; /* εσωτερικό κενό δεξιά */
      box-sizing: border-box !important; /* να μετρά το padding στο πλάτος */
    }
    
    .report-view-section {
      padding: 2rem;
      background: linear-gradient(135deg,
        rgba(0, 51, 117, 0.04) 0%,
        rgba(0, 102, 179, 0.03) 50%,
        rgba(0, 176, 240, 0.02) 100%
      );
      position: relative;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .report-view-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(to right,
        transparent,
        rgba(0, 102, 179, 0.2),
        transparent
      );
    }
    
    /* Title styling */
    .report-view-section .report-title {
      margin-top: 0;
      margin-bottom: 20px;
      color: #333;
      font-size: 28px;
      font-weight: 600;
      line-height: 1.3;
    }
    
    .report-view-section h3 {
      margin-top: 25px;
      margin-bottom: 15px;
      color: #333;
      font-size: 20px;
      font-weight: 600;
    }
    
    /* Panel styling */
    .report-view-section .panel {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
      width: auto;
      max-width: 100%;
    }
    
    /* Refresh panel styling */
    .report-view-section .refresh-panel {
      width: 100%;
      max-width: 800px;
      margin-bottom: 25px;
    }
    
    .report-view-section .panel-heading {
      border-radius: 8px 8px 0 0;
      padding: 12px 15px;
    }
    
    .report-view-section .panel-body {
      padding: 15px;
    }
    
    /* Button styling */
    .report-view-section .btn {
      transition: all 0.3s ease;
      margin-bottom: 5px;
    }
    
    .report-view-section .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Table styling */
    .report-view-section table {
      width: 100%;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .report-view-section th {
      font-weight: 600;
      background-color: #f5f7f9;
      white-space: nowrap;
      padding: 10px 8px;
    }
    
    .report-view-section td {
      padding: 8px;
      vertical-align: middle;
    }
    
    /* Fix for pull-left class */
    .report-view-section .pull-left {
      float: none !important;
      width: 100% !important;
    }
    
    /* Ensure report filters (dropdowns) do not overflow to the right */
    .report-view-section .control-organization {
      display: inline-block;
      max-width: 100%;
      /* Remove custom dropdown arrow background from wrapper
         so we only see the native select arrow */
      background-image: none !important;
    }
    
    .report-view-section .control-organization select {
      max-width: 100%;
      width: 100%;
    }
    
    /* Table wrapper for horizontal scrolling */
    .report-table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    
    .report-table-wrapper table {
      min-width: 960px; /* Prevents column compression on small screens */
    }
    
    /* Responsive table for small screens */
    @media (max-width: 991px) {
      .report-view-section {
        padding: 1.5rem;
      }
      
      .report-view-section .report-title {
        font-size: 24px;
      }
      
      .report-view-section table {
        font-size: 13px;
      }
      
      .report-view-section th,
      .report-view-section td {
        padding: 6px;
      }
    }
    
    @media (max-width: 767px) {
      .report-view-section {
        padding: 1rem;
      }
      
      .report-view-section .report-title {
        font-size: 22px;
      }
      
      /* Add horizontal scrolling for tables on small screens */
      .report-view-section .pull-left {
        overflow-x: auto;
      }
      
      .report-view-section table {
        font-size: 12px;
        min-width: 600px; /* Ensure table doesn't get too compressed */
      }
    }
  </style>
{% endblock%}
